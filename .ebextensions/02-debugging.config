files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99-debug-env.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      # Log file
      LOGFILE="/var/log/eb-debug.log"

      echo "========== DEBUG INFO ==========" > $LOGFILE
      echo "Time: $(date)" >> $LOGFILE
      echo "" >> $LOGFILE

      echo "========== SSM PARAMETERS ==========" >> $LOGFILE
      EB_ENV=$(get-config environment -k EnvironmentName)
      APP_PREFIX=$(echo $EB_ENV | sed 's/-dev$\|-staging$\|-prod$//')
      ENV_TYPE=$(echo $EB_ENV | sed 's/^.*-\(dev\|staging\|prod\)$/\1/')

      echo "Environment: $EB_ENV" >> $LOGFILE
      echo "App Prefix: $APP_PREFIX" >> $LOGFILE
      echo "Env Type: $ENV_TYPE" >> $LOGFILE
      echo "" >> $LOGFILE

      # List all parameters for this application
      echo "All parameters under /$APP_PREFIX/$ENV_TYPE/:" >> $LOGFILE
      aws ssm get-parameters-by-path --path "/$APP_PREFIX/$ENV_TYPE/" --recursive --with-decryption 2>&1 >> $LOGFILE
      echo "" >> $LOGFILE

      # List specific parameters
      for param in "database-url" "api-access-token"; do
        echo "Parameter /$APP_PREFIX/$ENV_TYPE/$param:" >> $LOGFILE
        aws ssm get-parameter --name "/$APP_PREFIX/$ENV_TYPE/$param" --with-decryption 2>&1 >> $LOGFILE
        echo "" >> $LOGFILE
      done

      # Check if .env file exists
      echo "========== ENV FILES ==========" >> $LOGFILE
      if [ -f /var/app/current/.env ]; then
        echo ".env file exists in app directory:" >> $LOGFILE
        cat /var/app/current/.env | sed 's/=.*/=REDACTED/' >> $LOGFILE
      else
        echo ".env file does NOT exist in app directory" >> $LOGFILE
      fi
      echo "" >> $LOGFILE

      # Check environment variables
      echo "========== ENVIRONMENT VARIABLES ==========" >> $LOGFILE
      printenv | grep -E "^(NODE_ENV|PORT|LOG_LEVEL|DATABASE_URL|API_ACCESS_TOKEN)" | sed 's/=.*/=REDACTED/' >> $LOGFILE
      echo "" >> $LOGFILE

      echo "Debug info generated at $(date)" >> $LOGFILE
