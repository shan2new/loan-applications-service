files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/00-check-permissions.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      # Log file
      LOGFILE="/var/log/eb-permissions.log"

      echo "Checking IAM permissions at $(date)" > $LOGFILE

      # Get instance profile
      INSTANCE_PROFILE=$(curl -s http://169.254.169.254/latest/meta-data/iam/info | grep InstanceProfileArn | cut -d'"' -f4)
      echo "Instance profile: $INSTANCE_PROFILE" >> $LOGFILE

      # Get environment name and extract parameters path
      EB_ENV=$(get-config environment -k EnvironmentName)
      APP_PREFIX=$(echo $EB_ENV | sed 's/-dev$\|-staging$\|-prod$//')
      ENV_TYPE=$(echo $EB_ENV | sed 's/^.*-\(dev\|staging\|prod\)$/\1/')
      PARAMS_PATH="/$APP_PREFIX/$ENV_TYPE"

      echo "Will check permissions for parameters under: $PARAMS_PATH" >> $LOGFILE

      # Test SSM permission
      echo "Testing SSM Parameter Store access..." >> $LOGFILE
      if aws ssm describe-parameters --max-items 1 >> $LOGFILE 2>&1; then
        echo "SSM Parameter Store describe permissions: OK" >> $LOGFILE
      else
        echo "ERROR: Missing permissions to describe SSM parameters" >> $LOGFILE
      fi

      # Test parameter access permission
      echo "Testing Parameter access..." >> $LOGFILE
      aws ssm get-parameters-by-path --path "$PARAMS_PATH" --recursive --max-items 1 >> $LOGFILE 2>&1
      if [ $? -eq 0 ]; then
        echo "SSM Parameter access for $PARAMS_PATH: OK" >> $LOGFILE
      else
        echo "ERROR: Missing permissions to access parameters under $PARAMS_PATH" >> $LOGFILE
      fi

      echo "Permission check completed at $(date)" >> $LOGFILE
