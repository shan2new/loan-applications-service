version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - 'echo Installing dependencies for testing...'
      - 'node --version'
      - 'npm --version'
      - 'npm install'

  pre_build:
    commands:
      - 'echo Setting up test environment...'
      - 'export CI=true'
      - 'npm run lint || echo "Linting warnings ignored"'
      - 'mkdir -p ./test-results/junit'

  build:
    commands:
      - 'echo Running test suite...'
      - 'npm run test:ci || echo "Tests completed with errors"'

  post_build:
    commands:
      - 'echo Tests completed at `date`'
      - 'echo Checking for test reports...'
      - 'ls -la ./test-results/junit || echo "No test reports found"'

artifacts:
  files:
    - 'junit.xml'
    - 'test-results/**/*'
    - 'coverage/**/*'
  base-directory: '.'
  discard-paths: no

cache:
  paths:
    - 'node_modules/**/*'

env:
  variables:
    CI: 'true'
    JEST_JUNIT_OUTPUT_DIR: './test-results/junit/'
    JEST_JUNIT_OUTPUT_NAME: 'junit.xml'
    JEST_JUNIT_CLASSNAME: '{classname}'
    JEST_JUNIT_TITLE: '{title}'
